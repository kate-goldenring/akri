# This is the configuration for Porter
# You must define steps for each action, but the rest is optional
# See https://porter.sh/author-bundles for documentation on how to configure your bundle
# Uncomment out the sections below to take full advantage of what Porter can do!

name: akri
version: 0.1.1
description: "A CNAB bundle that installs and operates the installation of https://github.com/deislabs/akri, a Kubernetes device plugin implementation that makes it possible for you to name the device you want, find that device, and start using it right away."
tag: ghcr.io/squillace

# If you want to customize the Dockerfile in use, uncomment the line below and update the referenced file. 
# See https://porter.sh/custom-dockerfile/
#dockerfile: Dockerfile.tmpl

mixins:
  - helm3:
      clientVersion: v3.3.4
      repositories:
        akri-helm-charts:
          url: "https://deislabs.github.io/akri"

install:
  - helm3:
      description: "Use Helm 3 to deploy the akri helm chart."
      upsert: true # uses "helm3 upgrade --install" instead of install. Can't use --replace.
      name: akri # parameterize
      chart: akri-helm-charts/akri-dev
#      version: CHART_VERSION
      namespace: "{{bundle.parameters.akri-namespace}}"
#      replace: true # removed to enable upsert behavior
      wait: true # default true
      set:
        useLatestContainers: true
        
upgrade:
  - helm3:
      description: "Using Helm 3 to upgrade the Akri Helm chart"
      name: akri # parameterize
      chart: akri-helm-charts/akri-dev
      namespace: "{{bundle.parameters.akri-namespace}}"
      resetValues: false
      reuseValues: true
      wait: true # default true
      set:
        onvif.enabled: "{{bundle.parameters.onvif-enabled}}"
        udev.enabled: "{{bundle.parameters.udev-enabled}}"
        udev.udevRules[0]: "{{bundle.parameters.udev-udevRules[0]}}"
        udev.brokerPod.image.repository: "{{bundle.parameters.udev-brokerPod-image-repository}}"
        udev.brokerPod.image.tag: "{{bundle.parameters.udev-brokerPod-image-tag}}"
    
uninstall:
  - helm3:
      description: "Deleting akri resources."
      namespace: "{{bundle.parameters.akri-namespace}}"
      releases:
        - akri


# Below is an example of how to define credentials
# See https://porter.sh/author-bundles/#credentials
credentials:
  - name: kubeconfig
    path: /root/.kube/config

# Below is an example of how to define parameters
# See https://porter.sh/author-bundles/#parameters
# TODO: add all values from akri/deployment/helm/values.yaml
parameters:
  - name: akri-namespace
    type: string
    default: default
  - name: onvif-enabled
    type: boolean
    default: false
  - name: udev-enabled
    type: boolean
    default: false
  - name: udev-udevRules[0] # issues with quotations being propagated
    type: string
    default: ""
  - name: udev-brokerPod-image-repository
    type: string
    default: ""
  - name: udev-brokerPod-image-tag
    type: string
    default: ""

# Flow
# navigate to akri/cnab
# porter build
# porter install --cred kubeconfig
# install onvif config: porter upgrade --cred kubeconfig --param onvif-enabled=true


# udev (DOES NOT WORK): porter upgrade --cred kubeconfig --param udev-enabled=true --param udev-udevRules[0]="KERNEL=="video[0-9]*""
# onvif: porter upgrade --cred kubeconfig --param onvif-enabled=true